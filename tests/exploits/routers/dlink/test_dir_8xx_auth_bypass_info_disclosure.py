from flask import request
#from routersploit.modules.exploits.routers.dlink.dir_8xx_auth_bypass_info_disclosure import Exploit


def apply_response():
    """ Response for exploit requests """

    if "A" not in request.args.keys():
        response = "<html><body><div>Authentication Fail!</div></body></html>"
    else:
        response = """
<html>
    <script type="text/javascript" charset="utf-8" src="/js/configuration/DeviceConfig.js"></script>
    <script>
        function GetLangcode()
        {
            var langcode = "";
            document.getElementById("langcode").innerHTML = (langcode=="")? "en":langcode;
        }
        function toHex( n )
        {
            var digitArray = new Array('0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f');
            var result = ''
            var start = true;
            for (var i=32; i>0;)
            {
                i -= 4;
                var digit = ( n >> i ) & 0xf;
                if (!start || digit != 0)
                {
                    start = false;
                    result += digitArray[digit];
                }
            }
            return ( result == '' ? '0' : result );
        }
        function pad( str, len, pad )
        {
            var result = str;
            for (var i=str.length; i<len; i++)
            {
                result = pad + result;
            }
            return  result;
        }
        function EncodeHex()
        {
            var str = "2016 11 29 12 04";
            var result = "";
            for (var i=0; i<str.length; i++)
            {
                if (str.substring(i,i+1).match(/[^\\x00-\\xff]/g) != null)
                {
                    result += escape(str.substring(i,i+1), 1).replace(/%/g,'\\\\');
                }
                else
                {
                    result += pad(toHex(str.substring(i,i+1).charCodeAt(0)&0xff),2,'0');
                }
            }
            document.getElementById("checksum").innerHTML = result.substring(result.length-8,result.length);
        }
        function GetQueryUrl()
        {
            var fwsrv = "wrpd.dlink.com";
            var fwpath= "/router/firmware/query.aspx";
            var model = "DIR-885L";
            var fwver = "1.13";
            var hwstr = "";
            var hwver = "Ax";
            if (hwstr == "")
            {
                hwstr = "A2";
            }
            function removeSymbol(input, symbol)
            {
                var ary = input.split(symbol);
                var res = "";
                for (var i=0;i<ary.length;i++)
                {
                    res += ary[i];
                }
                return res;
            }
            var mac = removeSymbol("10:62:eb:99:e9:5c", ":");
            fwver =removeSymbol(fwver,".");
            if (fwver.length == 3)
                fwver = "0"+fwver;
            else if(fwver.length > 3)
                fwver = "0" + fwver.substring(0,3);
            //get fw check parameter add by sam_pan
            var fwcheckparameter = "";
            // Get hw revision
            for(i=0; i<hwstr.length; i++)
            {
                char_code = hwstr.charAt(i);
                if ((char_code >= 'a' && char_code <= 'z') ||
                        (char_code >= 'A' && char_code <= 'Z'))
                {
                    hwver=char_code.toUpperCase()+"x";
                    break;
                }
            }
            if(fwcheckparameter == "")
            {
                fwcheckparameter =     hwver+"_Default";
            }
            else
            {
                fwcheckparameter = hwver+"_"+fwcheckparameter;
            }
            document.getElementById("fwq").innerHTML = "http:\\/\\/"+fwsrv+fwpath+"?model="+model+"_"+fwcheckparameter+"_FW_"+fwver+"_"+mac;
        }
        function Configured()
        {
            document.getElementById("configured").innerHTML = "0(Not default)";
        }
        function OnLoad()
        {
            GetLangcode();
            EncodeHex();
            GetQueryUrl();
            Configured();
            document.getElementById("fw_gui_ver").innerHTML = GUIVersion;
        }
    </script>
    <body onload="OnLoad();">
        <div">
            <h1>Version</h1>
            <div class="emptyline"></div>
            <div class="info">
                <span class="name">Firmware External Version :</span>
                <span class="value">V1.13</span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">Firmware External Revision :</span>
                <span class="value">b03</span>
            </div>
            <div class="info">
                <span class="name">Firmware Internal Version :</span>
                <span class="value" style="text-transform:uppercase;">V1.13b03</span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">Firmware GUI Version :</span>
                <span class="value" style="text-transform:uppercase;" id="fw_gui_ver"></span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">Language Package :</span>
                <span class="value" id="langcode"></span>
            </div>
            <div class="info">
                <span class="name">Date :</span>
                <span class="value">29, Nov, 2016</span>
            </div>
            <div class="info">
                <span class="name">CheckSum :</span>
                <span class="value" id="checksum"></span>
            </div>
            <div class="info">
                <span class="name">2.4GHz regulation domain :</span>
                <span class="value">
                  EU<br>&nbsp;&nbsp;1,2,3,4,5,6,7,8,9,10,11,12,13
                </span>
            </div>
            <div class="info"  >
                <span class="name">5GHz country code :</span>
                <span class="value">
                  EU/GB<br>&nbsp;&nbsp;36,40,44,48,
                </span>
            </div>
            <div class="info"  >
                <span class="name">5GHz DFS Channel :</span>
                <span class="value">
                </span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">802.11 country code :</span>
                <span class="value">
                  UK
                </span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">Bootcode Version :</span>
                <span class="value">1232</span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">Kernel :</span>
                <span class="value">Linux version 2.6.36.4brcmarm+ </span>
            </div>
            <div class="info">
                <span class="name">Firmware Query :</span>
                <span class="value" id="fwq"></span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">Apps :</span>
                <span class="value">Tue 29 Nov 2016</span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">WLAN Driver :</span>
                <span class="value">BGN band: BCM4331 + AC band: BCM4360</span>
            </div>
            <div class="info" >
                <span class="name">LAN MAC :</span>
                <span class="value">10:62:eb:99:e9:5c</span>
            </div>
            <div class="info" style="display:none;">
                <span class="name">WAN MAC :</span>
                <span class="value">10:62:eb:99:e9:5f</span>
            </div>
            <div class="info">
                <span class="name">2.4GHz WLAN MAC :</span>
                <span class="value">10:62:eb:99:e9:5c</span>
            </div>
            <div class="info"  >
                <span class="name">5GHz WLAN MAC :</span>
                <span class="value">
                10:62:eb:99:e9:5e</span>
            </div>
            <div class="info" style="display:none;" >
                <span class="name">5GHz WLAN MAC2 :</span>
                <span class="value">
                </span>
            </div>
            <div class="info">
                <span class="name">SSID (2.4G) :</span>
                <pre style="font-family:Tahoma"><span class="value">dlink-E95C</span></pre>
            </div>
            <div class="info"  >
                <span class="name">SSID (5G) :</span>
                <pre style="font-family:Tahoma"><span class="value">dlink-E95C</span></pre>
            </div>
            <div class="info" style="display:none;" >
                <span class="name">SSID (Secondary 5G) :</span>
                <pre style="font-family:Tahoma"><span class="value">dlink</span></pre>
            </div>
            <div class="info">
                <span class="name">Factory Default :</span>
                <span class="value" id="configured"></span>
            </div>
            <div class="gap"></div>
            <div class="info">
                <span class="name"></span>
                <span class="value">
                    <input type="button" value="Continue" onClick='self.location.href="Home.html";' />
                </span>
            </div>
            <div class="emptyline"></div>
        </div>
    </body>
</html>
"""
    return response, 200


def test_exploit_successful(target):
    return
    """ Test scenario - successful exploitation """

    cgi_mock = target.get_route_mock("/version.php", methods=["GET", "POST"])
    cgi_mock.side_effect = apply_response

    exploit = Exploit()
    exploit.target = target.host
    exploit.port = target.port

    assert exploit.check()
    assert exploit.run() is None
